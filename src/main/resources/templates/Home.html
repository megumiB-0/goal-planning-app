<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<div th:replace="~{fragment :: meta}"></div>
	<div th:replace="~{fragment :: styles}"></div>
	<!-- Chart.js をCDNで読み込み -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<!--<script src="https://cdn.jsdelivr.net/combine/npm/moment@2.29.1,npm/chartjs-adapter-moment@1.0.0"></script>-->
	<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
	<!-- FullCalendar（CSS & JS） -->
	<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>


<title>Goal Planning App</title>
</head>
<body>
	<div class="goalplanningapp-wrapper">
		<div th:replace ="~{fragment :: header}"></div>
			<main>
				<div class="container pt-4 pb-5 goalplanningapp-container">
					<div class="row mb-4">
						<div class="col-12">
						<!-- ログインメッセージ表示 -->
						<div th:if="${loginMessage}" class="justify-content-center alert alert-info mb-3">	
							<p th:text="${loginMessage}"></p>
						</div>
						<!-- 登録成功メッセージ表示 -->
						<div th:if="${successMessage}" class="justify-content-center alert alert-info mb-3">
							<p th:text="${successMessage}"></p>
						</div>
						<!-- エラーメッセージ表示-->
						<div th:if="${errorMessage}" class="justify-content-center alert-danger mb-3">
							<p th:text="${errorMessage}"></p>
						</div>
					</div>
					<!-- 目標設定済み -->
					<div th:if="${hasGoal}">
						<div class="row d-flex mb-4">
							 <div class="col-9">
								<h1 class="alert alert-light d-flex align-items-center gap-2">
									<i class="bi bi-flag-fill page-title-icon pe-3"></i>
									<span th:text="${message}"></span>
								</h1>
							 </div>
							 <div class="col-3 d-flex align-items-center justify-content-center">
								<a th:href="@{/plans}" class="btn btn-lg text-white shadow-sm goalplanningapp-btn px-4 py-2">
									学習予定を確認
								</a>
							 </div>
						</div>					
						<!-- 中段（左右分割） -->
						<div class="row equal-height align-items-stretch">
							<!-- 左側：7/12 -->
							<div class="col-md-7 mb-4">
								<div class="card p-3">
									<div class="d-flex justify-content-center align-items-center mb-3">
										<h4 class="mb-0  me-3">進捗グラフ</h4>
									</div>
										<canvas id="myChart"></canvas>			
									<script th:inline="javascript">
										/* <![CDATA[*/
										let studyData = /*[[${studyData}]]*/ [];
										let startDate = /*[[${startDate}]]*/ [];
										let goalDate = /*[[${goalDate}]]*/ [];
										let estimatedHours = /*[[${estimatedHours}]]*/ [];
										/*]]:*/	
									</script>
									<script src="/js/study-chart.js"></script>
								</div>
							</div>
							<!-- 右側：5/12（中に２段のカード） -->
							<div class="col-md-5 right-cards mb-4">
								<div class="d-flex gap-3">
									<!-- 上段横並び2枚 1/2 -->
									<div class="card flex-fill p-3 text-start">
										<p>目標達成度：</p>
										<div class="d-flex justify-content-center align-items-center mb-2">
											<span class="achievement-number" th:text="${achievementRate}"></span>
											<p class="achievement-percent">%</p>
										</div>
										<p>進捗評価：</p>
										<div class="d-flex justify-content-center mt-3">
											<i th:class="${evalIcon}"></i>
										</div>
									</div>
									<!-- 上段横並び2枚 2/2 -->
									<div class="card flex-fill p-3 text-start">
											<p>これまでの学習時間：</p>
											<div class="d-flex justify-content-center align-items-center mb-2">
												<span th:text="${todaysCumulativeHours}"></span>
												<p>時間</p>
											</div>
											<p>残り：</p>
											<div class="d-flex justify-content-center align-items-center mb-2">
												<span th:text="${remainingHours}"></span>
												<p>時間</p>
											</div>
									</div>
								</div>
								<!-- 上段横並びの下 -->
								<div class="card py-3 justify-content-center text-center">
									<p>1日　<span th:text="${estimatedperday}"></span>　時間 / 週　<span th:text="${estimatedperWeek}"></span>　時間の学習で達成見込み</p>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-12">
								<div class="card p-3 position-relative">
									    <div class="d-flex justify-content-center align-items-center mb-3">
      										<h4 class="mb-0  me-3">スケジュール & 実績入力</h4>
    										<a th:href="@{/home}" class="btn text-white shadow-sm goalplanningapp-btn">更新</a>
    									</div>
									<!-- カレンダー本体 -->
									<div id="calendar"></div>
									<!-- カレンダー用js -->
									<script src="/js/calendar.js"></script>
									<script>
									(async () =>{
										
										const calendarEl = document.getElementById('calendar');
										const calendar = await initLearningCalendar({
											calendarEl, 
											crudTarget:'records',		// 実績はCRUD
											showRecords: true,
											showPlans: false,
											showRoutines: true
											});
										calendar.render();
									})();
									</script>
								</div>
							</div>
						</div>
					</div>	
					<!-- 目標未設定 -->
					<div th:unless="${hasGoal}">
						<div class="d-flex justify-content-center my-4">
							<a th:href="@{/goals/setting}" class="btn btn-primary mt-2">目標設定</a>
						</div>											
					</div>
				</div>
			</main>
		<div th:replace="~{fragment :: footer}"></div>
		<div th:replace="~{fragment :: scripts}"></div>
	</div>	
</body>
</html>
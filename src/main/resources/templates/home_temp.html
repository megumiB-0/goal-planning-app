<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<div th:replace="~{fragment :: meta}"></div>
	<div th:replace="~{fragment :: styles}"></div>
	<!-- Chart.js をCDNで読み込み -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<!--<script src="https://cdn.jsdelivr.net/combine/npm/moment@2.29.1,npm/chartjs-adapter-moment@1.0.0"></script>-->
	<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
	<!-- FullCalendar（CSS & JS） -->
	<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>


<title>Goal Planning App</title>
</head>
<body class="d-flex flex-column vh-100">
	<div class="goalplanningapp-wrapper">
		<div th:replace ="~{fragment :: header}"></div>
			<main class="flex-grow-1">
				<div class="container pt-4 pb-5 goalplanningapp-container">
					<div class="row mb-4">
						<div class="col-12">
						<!-- ログインメッセージ表示 -->
						<div th:if="${loginMessage}" class="justify-content-center alert alert-info mb-3">	
							<p th:text="${loginMessage}"></p>
						</div>
						<!-- 登録成功メッセージ表示 -->
						<div th:if="${successMessage}" class="justify-content-center alert alert-info mb-3">
							<p th:text="${successMessage}"></p>
						</div>
						<!-- エラーメッセージ表示-->
						<div th:if="${errorMessage}" class="justify-content-center alert-danger mb-3">
							<p th:text="${errorMessage}"></p>
						</div>
					</div>
					<!-- 目標設定済み -->
					<div th:if="${hasGoal}">
						<div class="row d-flex mb-4">
							 <div class="col-10">
								<div class="card goal-card">
									<h1>
										<i class="bi bi-flag-fill page-title-icon pe-3"></i>
										<span th:text="${message}"></span>
									</h1>
								</div>
							 </div>
							 <div class="col-2 d-flex align-items-center justify-content-end">
								<a th:href="@{/plans}" class="btn btn-primary btn-lg text-white shadow-sm  px-4 py-2">
									学習予定を確認
								</a>
							 </div>
						</div>					
						<!-- 中段（左右分割） -->
						<div class="row equal-height align-items-stretch">
							<!-- 左側：7/12 -->
							<div class="col-md-7 mb-4">
								<div class="card p-3">
									<div class="d-flex justify-content-center align-items-center mb-3">
										<h4 class="home-title mb-0  me-3">進捗グラフ</h4>
									</div>
										<canvas id="myChart"></canvas>			
									<script th:inline="javascript">
										/* <![CDATA[*/
										let studyData = /*[[${studyData}]]*/ [];
										let startDate = /*[[${startDate}]]*/ [];
										let goalDate = /*[[${goalDate}]]*/ [];
										let estimatedHours = /*[[${estimatedHours}]]*/ [];
										/*]]:*/	
									</script>
									<script src="/js/study-chart.js"></script>
								</div>
							</div>
							<!-- 右側：5/12（中に２段のカード） -->
							<div class="col-md-5 right-cards mb-4">
								<div class="d-flex gap-3">
									<!-- 上段横並び2枚 1/2 -->
									<div class="card flex-fill p-3 text-start">
										<p>目標達成度：</p>
										<div class="d-flex justify-content-center align-items-center mb-2">
											<span class="achievement-number" th:text="${achievementRate}"></span>
											<p class="achievement-percent">%</p>
										</div>
										<div class="d-flex align-items-center gap-2">
											<p>進捗評価：</p>
											<!-- ヘルプアイコン -->
											<i class="bi bi-info-circle text-secondary help-icon"
											   data-bs-toggle="popover"
											   data-bs-toggler="focus"
											   data-bs-html="true"
											   data-bs-placement="right"
											   data-bs-content="
											   <div><i class='bi bi-fire'></i> <strong>順調</strong>：予定を10%以上上回るペース</div>
											   <div><i class='bi bi-sun-fill'></i> <strong>標準</strong>：予定通りのペース</div>
											   <div><i class='bi bi-cloud-fill'></i> <strong>注意</strong>：予定を若干下回るペース</div>
											   <div><i class='bi bi-umbrella-fill'></i> <strong>遅延</strong>：予定を10%以上下回るペース</div>
											   ">
											</i>
										</div>
										<div class="d-flex justify-content-center mt-3">
											<i th:class="${evalIcon}" class="progress-eval-icon"></i>
										</div>
									</div>
									<!-- 上段横並び2枚 2/2 -->
									<div class="card flex-fill p-3 text-start">
											<p>これまでの学習時間：</p>
											<div class="d-flex justify-content-center align-items-center mb-2">
												<span th:text="${todaysCumulativeHours}"></span>
												<p>時間</p>
											</div>
											<p>残り：</p>
											<div class="d-flex justify-content-center align-items-center mb-2">
												<span th:text="${remainingHours}"></span>
												<p>時間</p>
											</div>
									</div>
								</div>
								<!-- 上段横並びの下 -->
								<div class="card py-3 justify-content-center text-center">
									<p>1日　<span th:text="${estimatedperday}"></span>　時間 / 週　<span th:text="${estimatedperWeek}"></span>　時間の学習で達成見込み</p>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-12">
								<div class="card p-3 position-relative">
									    <div class="d-flex justify-content-center align-items-center my-3">
      										<h4 class="home-title mb-0  me-3">スケジュール & 実績入力</h4>
    									</div>
									    <div class="d-flex justify-content-end mb-3 me-4">
    										<a th:href="@{/home}" class="btn btn-primary btn-lg text-white shadow-sm ">グラフに反映</a>
    									</div>
									<!-- カレンダー本体 -->
									<div id="calendar"></div>
									<!-- カレンダー用js -->
									<script src="/js/calendar.js"></script>
									<script>
									(async () =>{
										
										const calendarEl = document.getElementById('calendar');
										const calendar = await initLearningCalendar({
											calendarEl, 
											crudTarget:'records',		// 実績はCRUD
											showRecords: true,
											showPlans: false,
											showRoutines: true
											});
										calendar.render();
									})();
									</script>
								</div>
							</div>
						</div>
					</div>	
					<!-- 目標未設定 -->
					<div th:unless="${hasGoal}">
						<div class="d-flex justify-content-center my-4">
							<a th:href="@{/goals/setting}" class="btn btn-primary mt-2">目標設定</a>
						</div>											
					</div>
				</div>
			</main>
			<!-- 目標達成時のポップアップ表示 -->
			<div class="modal fade" id="goalAchievedModal" tabindex="-1"
				 aria-labelledby="goalAchievedModalLabel"
				 aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="goalAchievedModalLabel">
								目標時間に到達しました！
							</h5>
						</div>
						<div class="modal-body text-center">
							<div id="goalChoice">
								<p><strong>完了</strong>しますか？</p>
								<p><strong>延長</strong>してもう少し学習を続けますか？</p>
								<div class="d-flex justify-content-center gap-3 mt-3">
									<!-- 完了 -->
									<form th:action="@{/goals/complete}" method="post" onsubmit="showCongrats()">
										<button type="submit" class="btn btn-primary">
											完了する
										</button>
									</form>
									<!-- 延長 -->
									<a th:href="@{/goals/edit}" class="btn btn-outline-primary">延長する</a>
								</div>
							</div>
							<!-- 目標達成のみお祝い表示 -->
							<div id="congratulation" class="text-center d-none mt-4">
								<img src="/images/trophy_logo.png" alt="congrats" width="200">
								<p class="mt-3 fs-5">目標を達成しました！</p>
							</div>
						</div>
					</div>
				</div>	 
			</div> 
			<script>
				document.addEventListener('DOMContentLoaded', () => {
					document
						.querySelectorAll('[data-bs-toggle="popover"]')
						.forEach(el => new bootstrap.Popover(el));
				})
			</script>
			<script th:if="${showGoalModal}">
				document.addEventListener('DOMContentLoaded', function(){
					// モーダル表示
					const modal = new bootstrap.Modal(
						document.getElementById('goalAchievedModal')
					);
					modal.show();
				});
				function showCongrats() {
					document.getElementById('goalChoice').classList.add('d-none');
					document.getElementById('congratulation').classList.remove('d-none');
					setTimeout(() => {
						form.submit();
					},1000);
					return false;
				}
			</script>
		<div th:replace="~{fragment :: footer}"></div>
		<div th:replace="~{fragment :: scripts}"></div>
	</div>	
</body>
</html>